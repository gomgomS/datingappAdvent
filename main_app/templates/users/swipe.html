<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Favico -->
    <link rel="shortcut icon" href="../../static/assets/img/favicon.png" type="image/x-icon">
    <link rel="icon" href="../../static/assets/img/favicon.png" type="image/x-icon">
    <title>comes.id - </title>
    <!-- vendor css -->
    <link href="../../static/lib/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
    <link href="../../static/lib/ionicons/css/ionicons.min.css" rel="stylesheet">
    <link href="../../static/lib/select2/css/select2.min.css" rel="stylesheet">
    <link href="../../static/lib/flatpicker/flatpickr.min.css" rel="stylesheet">
    <!-- DashForge CSS -->
    <link rel="stylesheet" href="../../static/assets/css/dashforge.css">
    <link rel="stylesheet" href="../../static/css/custom.css">
    <!-- some additional css here -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;900&display=swap');
        
        html, body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #FFDE59 0%, #FFB347 100%);
        }

        .frame {
          position: relative;
          width: 56vh;
          height: 84vh;
          max-width: 400px;
          max-height: 600px;
          z-index: 1; /* stays below detail-trigger which is z-index:21 */
        }

        .icons {
          margin-top: 3vh;
          user-select: none;
          z-index: 1;
        }

        .icons > svg {
          width: 10vh;
          height: 10vh;
          max-width: 60px;
          max-height: 60px;
          border-radius: 50%;
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
          cursor: pointer;
        }

        .icons > svg:nth-child(1) { fill: #fb4f68; margin-right: 2vh; }
        .icons > svg:nth-child(2) { fill: #4dca93; }
        .icons > svg > path:nth-child(1) { fill: #fff; }

        .card_swipe {
          position: absolute;
          display: flex;
          align-items: flex-end;
          justify-content: center;
          width: 100%;
          height: 100%;
          color: #f1f1f1;
          border-radius: 10px;
          user-select: none;
          cursor: pointer;
          overflow: hidden;
          background-size: cover;
          background-repeat: no-repeat;
          background-position: center;
          touch-action: none;
        }

        .card_swipe .is-like {
          width: 100%;
          height: 100%;
          position: absolute;
          opacity: 0;
        }
        .card_swipe .is-like::after {
          position: absolute;
          left: 50%;
          bottom: 30%;
          transform: translateX(-50%) rotate(-10deg);
          width:70%;
          height: 13%;
          font-size: 3em;
          letter-spacing: 0.2em;
          font-weight: 600;
          border-radius: 0.15em;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .card_swipe .like::after {
          content: "KASIH";
          color: #4dca93;
          border: 0.1em solid #4dca93;
        }

        .card_swipe .nope::after {
          content: "X KASIH";
          color: #fb4f68;
          border: 0.1em solid #fb4f68;
        }

        .card_swipe .bottom {
          width: 100%;
          height: 25%;
          background: linear-gradient(to top, #00000080, #00000000);
          display: flex;
          flex-direction: column;
          align-items: flex-start;
          justify-content: center;
          padding-left: 7%;
          font-weight: 400;
        }

        .card_swipe .bottom .title > span:nth-child(1) {
          font-size: 2em;
          font-weight: 700;
          margin-right: 0.2em;
        }

        .card_swipe .bottom .title > span:nth-child(2) {
          font-size: clamp(13px, 1.5em, 25px);
        }

        .card_swipe .bottom .title > span:nth-child(2) > b {
          font-size: 0.6em;
          margin-right: 0.2em;
        }

        .card_swipe .bottom .info {
          margin: 3% 0 0 2%;
          font-size: clamp(10px, 1.1em, 20px);
        }

        @media screen and (max-height: 540px) {
          .frame {
            width: 54vh;
            height: 81vh;
            font-size: 13px;
          }
        }

        @media screen and (max-height: 440px) {
          .frame {
            font-size: 8px;
          }
        }
        .card {
          width: 100%;
          max-width: 400px; /* Keep it responsive */
          border-radius: 10px;
          overflow: hidden;
          background-size: cover;
          background-repeat: no-repeat;
          background-position: center;
        }

        .icons > svg {
          width: 50px;
          height: 50px;
          cursor: pointer;
          transition: transform 0.2s ease-in-out;
        }

        .icons > svg:hover {
          transform: scale(1.1);
        }

        /* Middle Image Placeholder */
        .frame {
            width: 56vh;
            height: 70vh; /* Adjusted to prevent overlapping */
            max-width: 400px;
            max-height: 550px;
            border-radius: 20px;
            background: white;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
            margin: 80px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            /* background: url('your-image.jpg') no-repeat center center; */
            background-size: cover;
        }

        /* Bumble-inspired Menu Styling */
        :root {
            --bumble-yellow: #FFDE59;
            --bumble-dark: #333;
            --glass-bg: rgba(255, 255, 255, 0.3);
            --glass-border: rgba(255, 222, 89, 0.3);
        }

        /* Top & Bottom Menu Box */
        .menu-top, .menu-bottom {
            width: 90%;
            max-width: 420px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            padding: 12px 20px;
            border-radius: 20px;
            border: 2px solid var(--glass-border);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            position: absolute;
            color: var(--bumble-dark);
            z-index: 20;
            transition: all 0.3s ease;
        }
        /* Floating Detail Button (above bottom menu) */
        .detail-trigger {
            position: absolute;
            bottom: 85px; /* sit just above .menu-bottom (bottom:15px) */
            width: 90%;
            max-width: 420px;
            display: flex;
            justify-content: center;
            z-index: 21; /* above .frame and menus */
            pointer-events: auto;
        }

        .detail-trigger .btn {
            border-radius: 9999px;
            padding: 8px 20px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.12);
            background-color: var(--bumble-dark);
            border: none;
            color: var(--bumble-yellow);
            font-weight: 600;
        }

        .detail-trigger .btn:hover {
            background-color: #555;
            color: var(--bumble-yellow);
        }

        .menu-top {
            top: 15px;
        }

        .menu-bottom {
            bottom: 15px;
            justify-content: space-around;
        }

        /* Menu Item Buttons */
        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            font-size: 14px;
            color: var(--bumble-dark);
            transition: transform 0.2s ease, color 0.3s ease;
        }

        .menu-item:hover {
            transform: scale(1.08);
            color: var(--bumble-yellow);
        }

        /* Active Item */
        .menu-item.active {
            color: var(--bumble-yellow);
            pointer-events: none;
            font-weight: bold;
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Icon Styling */
        .menu-icon {
            font-size: 20px;
            margin-bottom: 4px;
            color: var(--bumble-dark);
            transition: color 0.2s ease;
        }
        
        .menu-icon:hover {
            color: var(--bumble-yellow);
        }
        
        .undo-button {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--bumble-dark);
            transition: color 0.2s ease;
            font-size: 20px;
        }
        
        .undo-button:hover {
            color: var(--bumble-yellow);
        }

        /* Responsive Adjustments */
        @media screen and (max-width: 768px) {
            .menu-icon {
                font-size: 18px;
            }
            .menu-item {
                font-size: 12px;
            }
        }

        @media screen and (max-height: 600px) {
            .frame {
                height: 60vh;
                max-height: 450px;
            }
        }

        /* Loading Card with Bumble vibes */
        .loading-card {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #FFDE59, #FFB347); /* yellow gradient */
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-family: 'Segoe UI', sans-serif;
            color: var(--bumble-dark);
        }

        .loading-content {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .sda-logo {
            font-size: 2rem;
            font-weight: bold;
            color: var(--bumble-dark);
            margin-bottom: 1rem;
        }

        .sda-logo span {
            color: var(--bumble-yellow); /* yellow accent */
            font-weight: normal;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid var(--bumble-dark);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }


        /* Smooth image zoom */
        #album img {
          transition: transform 0.3s ease-in-out;
          border-radius: 10px;
          cursor: pointer;
          margin-bottom: 15px;
        }

        #album img:hover {
          transform: scale(1.08);
        }

        .modal-content {
          border-radius: 15px;
          background: rgba(255, 255, 255, 0.95);
          box-shadow: 0 15px 40px rgba(0,0,0,0.1);
          backdrop-filter: blur(10px);
        }

        .profile-header {
          text-align: center;
          background: linear-gradient(145deg, #FFDE59, #FFB347);
          color: var(--bumble-dark);
          padding: 30px 20px;
          border-top-left-radius: 15px;
          border-top-right-radius: 15px;
        }

        /* MODAL DETAIL SOULMATE */
        /* Bumble-style Modal Profile */
        .bumble-profile {
          border-radius: 20px;
          overflow: hidden;
          background: rgba(255, 255, 255, 0.95);
          box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
          font-family: 'Segoe UI', sans-serif;
          backdrop-filter: blur(10px);
          max-height: 90vh;
          overflow-y: auto;
        }

        /* Header Section */
        .profile-header {
          padding: 24px;
          background: linear-gradient(145deg, #FFDE59, #FFB347);
          text-align: center;
        }

        /* Profile Image */
        /* Large responsive profile image that never crops (keeps aspect ratio) */
        .profile-cover {
          width: 100%;
          max-height: 50vh;
          border-radius: 14px;
          overflow: hidden;
          background: #f5f5f5;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .profile-cover .profile-photo,
        .profile-photo {
          max-width: 100%;
          max-height: 50vh;
          width: auto;
          height: auto;
          object-fit: contain;
          border-radius: 0;
          display: block;
        }

        /* Section Titles */
        .section-title {
          font-weight: 600;
          font-size: 16px;
          color: var(--bumble-dark);
          border-bottom: 2px solid var(--bumble-yellow);
          display: inline-block;
          margin-bottom: 14px;
          padding-bottom: 6px;
        }

        /* Info Grid */
        .profile-info-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 16px;
          padding: 16px 24px;
        }

        /* Info Cards */
        .info-item {
          background: rgba(255, 222, 89, 0.2);
          padding: 14px;
          border-radius: 14px;
          display: flex;
          align-items: center;
          gap: 10px;
          font-size: 14px;
          box-shadow: 0 2px 6px rgba(0,0,0,0.05);
          color: var(--bumble-dark);
        }

        .info-item.wide {
          grid-column: span 2;
        }

        .info-item i {
          color: var(--bumble-yellow);
          font-size: 18px;
        }

        /* Hide sensitive info */
        #email,
        #username,
        .d-none {
          display: none !important;
        }

        /* Album Grid */
        #album-photos {
          padding: 0 24px 20px;
        }

        #album-photos img {
          width: 100%;
          height: 160px;
          object-fit: cover;
          border-radius: 12px;
          box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }

        /* Footer */
        .modal-footer {
          border-top: none;
          padding: 16px 24px 24px;
          display: flex;
          justify-content: flex-end;
          gap: 12px;
        }

        .modal-footer .btn {
          background-color: var(--bumble-dark);
          border: none;
          border-radius: 30px;
          color: var(--bumble-yellow);
          padding: 8px 24px;
          font-weight: 600;
          transition: background 0.3s ease;
        }

        .modal-footer .btn:hover {
          background-color: #555;
          color: var(--bumble-yellow);
        }

        /* Responsive Optimizations */
        @media (max-width: 768px) {
          .modal-dialog {
            margin: 1rem;
          }

        .profile-cover { max-height: 40vh; }

          .profile-info-grid {
            grid-template-columns: 1fr;
          }

          .info-item.wide {
            grid-column: span 1;
          }

          #album-photos img {
            height: 140px;
          }
        }

      /* MODAL DETAIL SOULMATE */
     

      .custom-range {
        width: 100%;
      }

      .custom-control-label {
        cursor: pointer;
      }

      /* MODAL FILTER */
      /* Bumble-style modal content */
      .modal-content {
        background-color: rgba(255, 255, 255, 0.95); /* Semi-transparent white */
        border-radius: 1rem;
        border: none;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        max-height: 90vh;
        overflow-y: auto;
      }

      /* Redesigned Filter Modal */
      .filter-header-subtitle {
        font-size: 0.9rem;
        color: #666;
        margin-top: 6px;
      }
      .filter-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }
      .filter-chip {
        background: #fff;
        border: 1px solid var(--bumble-yellow);
        color: var(--bumble-dark);
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
      }
      .filter-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      @media (max-width: 768px) {
        .filter-grid { grid-template-columns: 1fr; }
      }
      .filter-card {
        background: #fff;
        border: 1px solid rgba(255, 222, 89, 0.3);
        border-radius: 12px;
        padding: 14px;
      }
      .filter-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }
      .filter-card-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        color: var(--bumble-dark);
      }
      .filter-card-title i { color: var(--bumble-yellow); }

      /* Header title */
      .modal-title {
        font-size: 1.3rem;
        color: var(--bumble-dark);
      }

      /* Section headings */
      .modal-body h6 {
        color: #666;
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      /* Form labels */
      .form-group label {
        font-weight: 500;
        color: var(--bumble-dark);
      }

      /* Range slider */
      input[type=range] {
        accent-color: var(--bumble-yellow);
      }

      /* Radio buttons */
      .custom-control-label::before {
        border-color: var(--bumble-yellow);
      }

      .custom-control-input:checked ~ .custom-control-label::before {
        background-color: var(--bumble-yellow);
        border-color: var(--bumble-yellow);
      }

      /* Buttons */
      .btn-primary {
        background-color: var(--bumble-dark);
        border-color: var(--bumble-dark);
        color: var(--bumble-yellow);
      }

      .btn-primary:hover {
        background-color: #555;
        border-color: #555;
        color: var(--bumble-yellow);
      }

      .btn-outline-secondary {
        border-color: #ccc;
        color: #666;
      }

      .btn-outline-secondary:hover {
        background-color: #eee;
        color: #333;
      }


      

      /* END MODAL FILTER */

      /* left middle part for info use filter */
      .filter-scope-box-static {
        position: absolute;
        left: 30px;
        top: 100px; /* adjust this to align vertically with the frame */         
        padding: 15px;
        
        width: 200px;
        font-size: 0.9rem;
        z-index: 5;
      }

      /* Optional: hide on small screens */
      @media (max-width: 768px) {
        .filter-scope-box-static {
          display: none;
        }
      }


      /* end left middle part for info use filter */

      /* Disabled (grey) look for filter sections when toggles are OFF */
      .disabled-section {
        opacity: 0.5;
        pointer-events: none;
        filter: grayscale(60%);
      }
    </style>
</head>

{% autoescape false %}
<body data-is-premium="{{ is_premium }}" data-user-id="{{ user_rec.user_id }}">
    <!-- Top Menu -->
    <div class="menu-top">
      <!-- Left controls: Filter + My Profile -->
      <div style="display:flex; align-items:center; gap:14px; z-index:22; position:relative;">
        <button type="button" class="menu-icon" data-toggle="modal" data-target="#filterModal" style="background:none;border:0;cursor:pointer;">
          <i class="fas fa-search"></i> 
        </button>
      </div>
    
      <div style="display: flex; align-items: center; gap: 15px;">
        <!-- Premium Icon -->
        <a id="undo-btn" class="undo-button" href="javascript:void(0);">
          <i class="fas fa-undo"></i>
        </a>
        
        <a href="/upgrade-premium" class="menu-icon" style="text-decoration: none;">
          <i class="fas fa-crown"></i> 
        </a>

        <!-- Logout Icon -->
        <a href="/auth/logout" class="menu-icon" style="text-decoration: none;">
          <i class="fas fa-sign-out-alt"></i>
        </a>
      </div>
    </div>    

    <!-- left middle part for info use filter -->
    <!-- Static Filter Scope Box -->
    <div class="filter-scope-box-static">
      <div class="sda-logo" style="display:none"></div>
    </div>            

    <!-- Middle Image -->
    <div class="frame"></div>

    <!-- Floating Detail Button (above bottom menu) -->
    <div class="detail-trigger">
      <div class="btn-group w-100" role="group" style="gap:8px; justify-content:center;">
        <button type="button" class="btn" id="btn-show-detail" onclick="showFutureWifeId()">
          <i class="fas fa-id-badge mr-1"></i>
          Detail
        </button>
        <button type="button" class="btn" id="btn-floating-my-profile" onclick="showFutureWifeId(document.body.getAttribute('data-user-id'))">
          <i class="fas fa-user mr-1"></i>
          My Profile
        </button>
      </div>
    </div>

    <!-- Bottom Menu -->
    <div class="menu-bottom">
      <!-- Swipe (Aktif) -->
      <div class="menu-item active">
          <i class="fas fa-fire"></i>
          <span>Swipe</span>
      </div>

      <!-- Match -->
      <a href="/match" class="menu-item">
          <i class="fas fa-heart"></i>
          <span>Match</span>
      </a>

      <!-- Chat -->
      <a href="/chat" class="menu-item">
          <i class="fas fa-comments"></i>
          <span>Chat</span>
      </a>


      <!-- Profile -->
      <a href="/profile_intro" class="menu-item">
          <i class="fas fa-user-ninja"></i>
          <span>Profil</span>
      </a>
      
      
    </div>
  


    <div id="loading-card" class="loading-card">
      <div class="loading-content">
        <div class="spinner"></div>
        <p>Loading matches...</p>
      </div>
    </div>

    <!-- Redesigned Dating App Modal -->
    <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content bumble-profile">
          <div class="modal-body">
            <!-- Cover Image Top -->
            <div class="profile-cover mb-3">
              <img id="profile-photo" class="profile-photo" src="" alt="Profile Photo">
            </div>
            
            <!-- Basic Info neatly arranged -->
            <div class="basic-info mb-3">
              <h3 id="name" class="mb-1">Name</h3>
              <div class="text-muted" style="font-size: 14px;">
                <span id="age">25</span>
                <span class="mx-1">•</span>
                <span id="job">Job Title</span>
                <span class="mx-1">•</span>
                <span id="city">City</span>
              </div>
            </div>

            <!-- Info Grid -->
            <div class="profile-info-grid mb-4">
              <div class="info-item d-none">
                <i class="fas fa-user-circle"></i>
                <span><strong>Username:</strong> <span id="username">Username</span></span>
              </div>
              <div class="info-item d-none">
                <i class="fas fa-envelope"></i>
                <span><strong>Email:</strong> <span id="email">Email</span></span>
              </div>
              <div class="info-item">
                <i class="fas fa-church"></i>
                <span><strong>Congregation:</strong> <span id="congregation">Registered Congregation</span></span>
              </div>
              <div class="info-item">
                <i class="fas fa-cross"></i>
                <span><strong>Advent Status:</strong> <span id="advent-status">Advent Status</span></span>
              </div>
              <div class="info-item">
                <i class="fas fa-heartbeat"></i>
                <span><strong>Hobbies:</strong> <span id="hobbies">Hobbies</span></span>
              </div>
              <div class="info-item">
                <i class="fas fa-people-arrows"></i>
                <span><strong>Tribe:</strong> <span id="tribe">Tribe</span></span>
              </div>
              <div class="info-item">
                <i class="fas fa-ring"></i>
                <span><strong>Marital Status:</strong> <span id="marital-status">Marital Status</span></span>
              </div>
              <div class="info-item wide">
                <i class="fas fa-comment-dots"></i>
                <span><strong>About:</strong> <span id="about">About</span></span>
              </div>
            </div>

            <!-- Photo Gallery at Bottom -->
            <div id="album" class="mb-2">
              <h6 class="section-title">Photo Gallery</h6>
              <div class="row row-cols-2 row-cols-md-3 g-3" id="album-photos"></div>
            </div>
          </div>

          <div class="modal-footer justify-content-center">
            <button type="button" class="btn btn-light rounded-pill px-4" data-dismiss="modal">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
    
    

      <!-- Full Image Modal (Bootstrap 4) -->
      <div class="modal fade" id="fullImageModal" tabindex="-1" role="dialog" aria-labelledby="fullImageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
          <div class="modal-content bg-dark text-white border-0">
            <div class="modal-header border-0">
              <button type="button" class="close text-white ml-auto" data-dismiss="modal" aria-label="Close" style="background-color: black;">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body p-0">
              <img id="full-image" class="img-fluid w-100" src="" alt="Full Image">
            </div>
          </div>
        </div>
      </div>

      <!-- 🎯 Redesigned Modal for Filters (Bumble Style) -->
    <div class="modal fade" id="filterModal" tabindex="-1" role="dialog" aria-labelledby="filterModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
      <div class="modal-content rounded-3 border-0 shadow-lg">

          <div class="modal-header border-0">
            <div>
              <h5 class="modal-title font-weight-bold mb-1" id="filterModalLabel">✨ Atur Kriteria Pasangan
                {% if is_premium == 'TRUE' %} 
                <span class="badge badge-warning ml-2" data-toggle="tooltip" title="Fitur lengkap tersedia untuk member premium!">You Are Premium Member</span>
                {% endif %}
              </h5>
              <div class="filter-header-subtitle">Sesuaikan preferensi Anda untuk menemukan pasangan yang cocok.</div>
              <div id="filter-chips" class="filter-chips"></div>
            </div>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>

          <div class="modal-body px-4 py-3">
            <div class="filter-grid">
              <!-- Age -->
                <div class="filter-card" id="card-age">
                <div class="filter-card-header">
                  <div class="filter-card-title"><i class="fas fa-birthday-cake"></i> Rentang Usia</div>
                  <div class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input" id="useAge" checked onchange="toggleAge(this.checked)">
                    <label class="custom-control-label" for="useAge"></label>
                  </div>
                </div>
                <div id="ageFilter">
                  <div class="d-flex align-items-center">
                    <input type="range" id="minAgeRange" min="18" max="60" value="18" class="custom-range mr-2" oninput="updateAgeRangeValue()">
                    <input type="range" id="maxAgeRange" min="18" max="60" value="35" class="custom-range ml-2" oninput="updateAgeRangeValue()">
                  </div>
                  <p class="small mb-0">Dipilih: <span id="ageRangeValue">18 - 35</span> tahun</p>
                </div>
              </div>

              <!-- Hometown -->
                <div class="filter-card" id="card-hometown">
                <div class="filter-card-header">
                  <div class="filter-card-title"><i class="fas fa-home"></i> Kota Asal</div>
                  <div class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input" id="useHometown" checked onchange="toggleHometown(this.checked)">
                    <label class="custom-control-label" for="useHometown"></label>
                  </div>
                </div>
                <div id="hometownFilter">
                  <select class="form-control" id="hometown" name="hometown"
                    {% if is_premium != 'TRUE' %} onchange="handleCityChange(this)" {% endif %}>
                    <option value="">Pilih Kota Asal</option>
                    {% for city in city_list %}
                      {% if city not in ['Jakarta', 'Semarang', 'Bandung', 'Surabaya'] and is_premium != 'TRUE' %}
                        <option value="{{ city }}">{{ city }} ✨✨✨ </option>
                      {% else %}
                        <option value="{{ city }}">{{ city }}</option>
                      {% endif %}
                    {% endfor %}
                  </select>
                </div>
              </div>

              <!-- Distance -->
                <div class="filter-card" id="card-distance">
                <div class="filter-card-header">
                  <div class="filter-card-title"><i class="fas fa-map-marker-alt"></i> Radius Pencarian</div>
                  <div class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input" id="useDistance"
                      {% if is_premium != 'TRUE' %}
                        onclick="$('#premiumModal').modal('show'); return false;"
                      {% else %}
                        onchange="toggleDistance(this.checked)"
                      {% endif %}>
                    <label class="custom-control-label" for="useDistance"></label>
                  </div>
                </div>
                <div id="distanceFilter">
                  <input type="range" id="distanceRange" min="0" max="100" value="0" class="custom-range" oninput="handleDistanceChange()" disabled>
                  <p class="small mb-0">Dipilih: <span id="distanceValue">0</span> km</p>
                  <div id="searcher-location" class="small text-muted mt-2" style="display:none;">
                    <i class="fas fa-location-arrow"></i>
                    Lokasi Anda: <span id="loc-city"></span><span id="loc-prov"></span><span id="loc-country"></span>
                  </div>
                  <div id="geo-control" class="small mt-2"></div>
                </div>
              </div>

              <!-- Marital Status -->
                <div class="filter-card" id="card-marital">
                <div class="filter-card-header">
                  <div class="filter-card-title"><i class="fas fa-ring"></i> Status Hubungan</div>
                  <div class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input" id="useMaritalStatus" checked
                      {% if is_premium != 'TRUE' %}
                        onclick="$('#premiumModal').modal('show'); return false;"
                      {% else %}
                        onchange="toggleMaritalStatus(this.checked)"
                      {% endif %}>
                    <label class="custom-control-label" for="useMaritalStatus"></label>
                  </div>
                </div>
                <div id="maritalStatusFilter">
                  {% for status in [
                    ('never-married', 'Lajang - Belum Pernah Menikah (never-married) '),
                    ('abandoned', 'Lajang - Ditinggalkan Pasangan (abandoned)'),
                    ('separated', 'Lajang - Pisah Tempat Tinggal (separated)'),
                    ('divorced', 'Lajang - Cerai (divorced)'),
                    ('widowed', 'Lajang - Duda/Janda (widowed)'),
                    ('complicated', 'Rumit (complicated)'),
                    ('other', 'Lainnya' 'other')
                  ] %}
                  <div class="custom-control custom-radio">
                    <input type="radio" id="{{ status.0 }}" name="maritalStatus" class="custom-control-input"
                      {% if is_premium != 'TRUE' %}
                        onclick="$('#premiumModal').modal('show'); return false;"
                      {% endif %}>
                    <label class="custom-control-label" for="{{ status.0 }}">{{ status.1 }}</label>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>

          <div class="modal-footer border-0 flex-column flex-sm-row justify-content-between align-items-stretch gap-2">
            <button type="button" class="btn btn-outline-secondary w-100 w-sm-auto" data-dismiss="modal">
              Tutup
            </button>
          
            <div class="d-flex flex-column flex-sm-row gap-2 w-100 w-sm-auto">
              <button type="button" class="btn btn-light w-100 w-sm-auto" onclick="resetFilters()">
                Reset Filter
              </button>
          
              <button type="button" id="apply-filters-btn" class="btn btn-primary w-100 w-sm-auto" onclick="openConfirmFilters()">
                Terapkan Filter
              </button>
            </div>
          </div>
          

        </div>
      </div>
    </div>



    <!-- limit swipe modal -->
    <div class="modal fade" id="modal-swipe-limit" tabindex="-1" role="dialog" aria-labelledby="swipeLimitLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header bg-warning text-white">
            <h5 class="modal-title" id="swipeLimitLabel">Swipe Limit Reached</h5>
            <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            You have reached your daily swipe limit. Upgrade to premium to continue swiping today.
          </div>
          <div class="modal-footer">
            <a href="/upgrade-premium" class="btn btn-primary">Upgrade to Premium</a>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Okay</button>
          </div>
        </div>
      </div>
    </div> 

    <!-- Modal Premium Only -->
        <!-- Modal untuk Premium Only -->
    <div class="modal fade" id="premiumModal" tabindex="-1" role="dialog" aria-labelledby="premiumModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content border-0 shadow">
          <div class="modal-header bg-warning text-white">
            <h5 class="modal-title" id="premiumModalLabel">Fitur Khusus Pengguna Premium</h5>
            <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body text-center">
            <p>Filter lanjutan ini hanya tersedia untuk pengguna <strong>Premium</strong>.</p>
            <button class="btn btn-primary mt-2" onclick="window.location.href='/upgrade-premium'">Daftar Premium Sekarang</button>
          </div>
        </div>
      </div>
    </div>

    <!-- modal for match found -->
    <div class="modal fade" id="modal-match-found" tabindex="-1" role="dialog" aria-labelledby="matchModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content text-center">
          <div class="modal-body">
            <h5 class="modal-title mb-3">🎉 Kalian Saling Menyukai!</h5>
            <div class="d-flex justify-content-center align-items-center mb-3">
              <img id="yourPhoto" src="" alt="You" class="rounded-circle mx-2" width="80" height="80">
              <span class="mx-2">💞</span>
              <img id="partnerPhoto" src="" alt="Partner" class="rounded-circle mx-2" width="80" height="80">
            </div>
            <p id="matchMessage" class="mb-0"></p>
          </div>
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-primary" data-dismiss="modal">Oke</button>
          </div>
        </div>
      </div>
    </div>
    

    
    <!-- Modal: Confirm Filters -->
    <div class="modal fade" id="confirmFilterModal" tabindex="-1" role="dialog" aria-labelledby="confirmFilterModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="confirmFilterModalLabel">Konfirmasi Pencarian</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p>Apakah Anda yakin ingin menggunakan kriteria berikut?</p>
            <div id="confirm-filter-summary" class="filter-chips"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Batal</button>
            <button type="button" id="confirm-apply-btn" class="btn btn-primary" onclick="onConfirmApplyFilters()">Mulai Pencarian</button>
          </div>
        </div>
      </div>
    </div>

    <input type="hidden" id="latitude">
    <input type="hidden" id="longitude">
    


    <!-- Font Awesome -->
    <script src="https://kit.fontawesome.com/41e808b0fd.js" crossorigin="anonymous"></script>

    <script src="../../static/lib/jquery/jquery.min.js"></script>
    <script src="../../static/lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="../../static/lib/feather-icons/feather.min.js"></script>
    <script src="../../static/lib/perfect-scrollbar/perfect-scrollbar.min.js"></script>
    <script src="../../static/lib/flatpicker/flatpickr.js"></script>
    <script src="../../static/assets/js/dashforge.js"></script>
    <script src="../../static/assets/js/dashforge.aside.js"></script>
    <script src="../../static/lib/select2/js/select2.min.js"></script>
   <script>
      let imgCount = 0
      // const cloudUrl = 'https://djjjk9bjm164h.cloudfront.net/'
      // const data = [
      //   {img: `${cloudUrl}tender01.jpg`, name: 'Korean Fried', price: '20', distance: '2'},
      //   {img: `${cloudUrl}tender02.jpg`, name: 'Grilled', price: '23', distance: '5'},
      //   {img: `${cloudUrl}tender03.jpg`, name: 'Fried', price: '25', distance: '11'},
      //   {img: `${cloudUrl}tender04.jpg`, name: 'Deep Fried', price: '23', distance: '6'}
      // ]    

      let skipCount = 0;
      const limit = 15;
      let swipedCount = 0;
      
      const frame = document.body.querySelector('.frame');
      let current = null; // ✅ Declare `current` globally
      let likeText = null;
      let startX = 0, startY = 0, moveX = 0, moveY = 0;

      // UNDO FEATURE 3 june works good still need improvement
      // now alredy append but still not show
      let lastSwipedCardData = null; // global variable to track last swipe

      document.querySelector('#undo-btn').onclick = () => {
        console.log("Stored:", lastSwipedCardData);

        undoSwipe();
      };

      function storeLastSwipedCard() {

        console.log("yeah")
        if (!current) return;
        console.log("oi")
        lastSwipedCardData = {
          img: current.style.backgroundImage.replace(/^url\(["']?/, '').replace(/["']?\)$/, ''),
          name: current.querySelector('.title span')?.innerText || '',
          age: current.querySelector('.title p')?.innerText.replace(' thn', '') || '',
          future_wife_id: current.dataset.futureWifeId,
          distance: '' // Optional, kalau kamu mau tambahkan
        };
      }      

      function undoSwipe() {
        if (!lastSwipedCardData) return;

        // ✅ Only restore the last swiped card
        appendSingleCard(lastSwipedCardData);

        current = frame.querySelector('.card_swipe:last-child');
        if (current) {
          likeText = current.children[0];

          // Animate card entrance from left
          current.style.transition = 'none';
          current.style.transform = 'translateX(-100vw) rotate(-30deg)';

          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              current.style.transition = 'transform 300ms ease';
              current.style.transform = 'translateX(0) rotate(0deg)';
            });
          });

          initcard_swipe(current);
        }
        
        current.dataset.futureWifeId = lastSwipedCardData.future_wife_id;

        lastSwipedCardData = null;
      }

      function appendSingleCard(data) {        
        const card = document.createElement('div');
        card.classList.add('card_swipe');

        // Set image as background if available
        if (data.img) {
          card.style.backgroundImage = `url(${data.img})`;
        }

        card.innerHTML = `
          <div class="is-like">LIKE</div>
          <div class="bottom">
            <div class="title">
              <span>${data.name}</span>
              <p>${data.age} thn</p>
            </div>
            <div class="info">
              ${data.bio || ''}
            </div>
          </div>
        `;

        frame.appendChild(card);
      }



      // END UNDO FEATURE

      var apiUrl = "/api/find/match";

     
      function fetchMatches(skip) {
        const fullUrl = `${apiUrl}?skip=${skip}&limit=${limit}`;
        $('#loading-card').show(); // Show full-page loader

        $.get(fullUrl, function(resp, status) {
          if (status !== "success") {
            console.error("Network response was not ok");
            $('#loading-card').hide(); // Hide loader
            return;
          }

          const data = resp.map(item => ({
            img: item.img,
            name: item.name,
            age: item.age,
            city: item.city,
            distance: item.distance,
            future_wife_id: item.user_id
          }));

          if (resp.length === 0 ) {
            // Jika data kosong, tampilkan card placeholder
            appendcard_swipe_empty({});
          } else {
            // Kalau ada data, append semua card
            data.forEach(item => appendcard_swipe(item));
          }

          current = frame.querySelector('.card_swipe:last-child');
          if (current) {
            likeText = current.children[0];
            initcard_swipe(current);
          }

           // Use a slight delay to ensure rendering is done before hiding loader
          setTimeout(() => {
            $('#loading-card').hide();
          }, 100); // Or increase delay to 100ms if needed

        }).fail(function(error) {
          console.error("Error fetching data:", error);
          $('#loading-card').hide(); // Hide loader
        });
      }


      fetchMatches(skipCount);
      document.querySelector('#like').onclick = () => {
        if (!current) return;
        moveX = 1;
        moveY = 0;
        sendDecision(current.dataset.futureWifeId, "acc"); // ✅ Send Accept
        complete();
      };

      document.querySelector('#hate').onclick = () => {
        if (!current) return;
        moveX = -1;
        moveY = 0;
        sendDecision(current.dataset.futureWifeId, "reject"); // ✅ Send Reject
        complete();
      };

      function appendcard_swipe(data) {        
        const firstcard_swipe = frame.children[0];
        const newcard_swipe = document.createElement('div');
        newcard_swipe.className = 'card_swipe';
        newcard_swipe.style.backgroundImage = `url(${data.img})`;
        newcard_swipe.dataset.futureWifeId = data.future_wife_id; // ✅ Store user ID
        newcard_swipe.innerHTML = `
                <div class="is-like">LIKE</div>
                <div class="bottom">
                  <div class="title">
                    <span>${data.name}</span>
                    <p>${data.age} thn - ${data.city}</p>
                  </div>
                  <div class="info">                   
                  </div>
                </div>
              `;
        if (firstcard_swipe) frame.insertBefore(newcard_swipe, firstcard_swipe);
        else frame.appendChild(newcard_swipe);

        // ✅ Update `current` when a new card is added
        current = newcard_swipe;
      }
      
      function appendcard_swipe_empty(filterData) {       

        // Render using the latest UI state merged with provided filterData
        const useAge = document.getElementById('useAge')?.checked;
        const minAge = document.getElementById('minAgeRange')?.value;
        const maxAge = document.getElementById('maxAgeRange')?.value;
        const useDistance = document.getElementById('useDistance')?.checked;
        const distanceRange = document.getElementById('distanceRange')?.value || '0';
        const hometown = document.getElementById('hometown')?.value || '';
        const currentCityEl = document.getElementById('currentCity');
        const currentCity = currentCityEl ? currentCityEl.value : '';
        const marital = document.querySelector("input[name='maritalStatus']:checked")?.id || '';

        const fd = Object.assign({
          min_age: useAge ? minAge : undefined,
          max_age: useAge ? maxAge : undefined,
          distance: (useDistance && distanceRange !== '0') ? distanceRange : '0',
          hometown: hometown || undefined,
          currentCity: currentCity || undefined,
          maritalStatus: marital || undefined,
        }, filterData || {});

        const usiaText = (fd.min_age && fd.max_age) ? `Usia ${fd.min_age}–${fd.max_age}` : '';
        const distanceText = (fd.distance && fd.distance !== "0") ? `Jarak max ${fd.distance} km` : '';
        const hometownText = fd.hometown ? `Asal ${fd.hometown}` : '';
        const currentCityText = fd.currentCity ? `Tinggal di ${fd.currentCity}` : '';
        const maritalStatusText = fd.maritalStatus ? `Status ${fd.maritalStatus}` : '';

        const criteriaList = [usiaText, distanceText, hometownText, currentCityText, maritalStatusText]
          .filter(Boolean)
          .join(', ');

        const message = criteriaList
          ? `Filter Anda saat ini: ${criteriaList}.`
          : `Tidak ada filter yang diterapkan.`;

        const newcard_swipe = document.createElement('div');
        newcard_swipe.className = 'card_swipe no-data';
        newcard_swipe.style.backgroundImage = 'none';
        newcard_swipe.innerHTML = `
          <div class="no-data-message" style="padding: 20px; text-align: center; color: #666;">
            <p>${message}</p>
            <p>Tidak ditemukan hasil. Silakan coba kriteria yang berbeda.</p>
          </div>
        `;

        frame.appendChild(newcard_swipe);
      }


      function initcard_swipe(card_swipe) {
        if (!card_swipe || card_swipe.classList.contains('no-data')) return;
        card_swipe.addEventListener('pointerdown', onPointerDown);
      }

      function getTopSwipeableCard() {
        const cards = Array.from(frame.querySelectorAll('.card_swipe'));
        for (let i = cards.length - 1; i >= 0; i--) {
          if (!cards[i].classList.contains('no-data')) return cards[i];
        }
        return null;
      }

      function setTransform(x, y, deg, duration) {
        if (!current || current.classList.contains('no-data')) return;
        current.style.transform = `translate3d(${x}px, ${y}px, 0) rotate(${deg}deg)`;
        likeText.style.opacity = Math.abs((x / innerWidth * 2.1));
        likeText.className = `is-like ${x > 0 ? 'like' : 'nope'}`;
        if (duration) current.style.transition = `transform ${duration}ms`;
      }

      function onPointerDown({ clientX, clientY }) {
        if (!current || current.classList.contains('no-data')) return;
        startX = clientX;
        startY = clientY;
        current.addEventListener('pointermove', onPointerMove);
        current.addEventListener('pointerup', onPointerUp);
        current.addEventListener('pointerleave', onPointerUp);
      }

      function onPointerMove({ clientX, clientY }) {
        if (!current || current.classList.contains('no-data')) return;
        moveX = clientX - startX;
        moveY = clientY - startY;
        setTransform(moveX, moveY, moveX / innerWidth * 50);
      }

      function onPointerUp() {
        if (!current || current.classList.contains('no-data')) return;
        current.removeEventListener('pointermove', onPointerMove);
        current.removeEventListener('pointerup', onPointerUp);
        current.removeEventListener('pointerleave', onPointerUp);
        if (Math.abs(moveX) > frame.clientWidth / 2) {
          current.removeEventListener('pointerdown', onPointerDown);
          
          storeLastSwipedCard(); // ✅ FIRST: Save data BEFORE DOM update
          sendDecision(current.dataset.futureWifeId, moveX > 0 ? "acc" : "reject"); // ✅ THEN send
          
          complete(); // Animate + remove
        } else {
          cancel(); // Snap back
        }
      }

      function complete() {
        if (!current) return;

        const flyX = (Math.abs(moveX) / moveX) * innerWidth * 1.3;
        const flyY = (moveY / moveX) * flyX;
        setTransform(flyX, flyY, flyX / innerWidth * 50, innerWidth);

        const prev = current;
        const next = current.previousElementSibling;

        if (next) {
          current = next;
          likeText = current.children[0];
          initcard_swipe(current);
        } else {
          current = null;
        }

        setTimeout(() => {
          if (prev) frame.removeChild(prev);

          swipedCount++;
          if (swipedCount % limit === 0) {
            skipCount += limit;
            fetchMatches(skipCount); // 👈 Load next batch after transition ends
          }

          // Ensure current always points to the top swipeable card
          if (!current || current.classList.contains('no-data')) {
            current = getTopSwipeableCard();
            if (current) {
              likeText = current.children[0];
              initcard_swipe(current);
            }
          }
        }, innerWidth); // Wait for animation duration
      }

      function cancel() {
        setTransform(0, 0, 0, 100);
        setTimeout(() => current.style.transition = '', 100);
      }

      function sendDecision(futureWifeId, status) {
        const apiUrl = "/api/decision/match";
        $.post(apiUrl, {
          csrf_token: "{{ csrf_token() }}", // CSRF token
          future_wife_id: futureWifeId,
          status: status
        })
        .done(function(response) {
          console.log(`Match decision sent: ${status}`, response);
          const userImg = "{{G_IMAGE_URL_DISPATCH}}" + "{{ user_rec.profile_photo }}"; // Replace if needed
          console.log(userImg)
          if (response.status === "limit_exceeded") {
            // Tampilkan modal
            $('#modal-swipe-limit').modal('show');

            // Panggil ulang fetchMatches agar kartu tetap muncul
            fetchMatches(0);
          }

          if (response.status === "match_found") {
            // Build full image URLs        
            const userImg = "{{G_IMAGE_URL_DISPATCH}}" + "{{ user_rec.profile_photo }}"; // Replace if needed
            const partnerImg = lastSwipedCardData.img;

            // Set modal content
            $('#yourPhoto').attr('src', userImg);
            $('#partnerPhoto').attr('src', partnerImg);
            $('#matchMessage').text(`Kamu dan ${lastSwipedCardData.name} saling menyukai! 🎉`);

            // Show modal
            $('#modal-match-found').modal('show');
          }

        })
        .fail(function(error) {
          console.error("Error sending match decision:", error);
        });
      }

      
       async function showFutureWifeId(futureIdFromBtn) {
         console.log('[MyProfile] showFutureWifeId called with:', futureIdFromBtn);
         let futureId = futureIdFromBtn;
         if (!futureId) {
           if (!current || !current.dataset.futureWifeId) {
             alert('No profile selected.');
             return;
           }
           futureId = current.dataset.futureWifeId;
         }
         console.log('[MyProfile] resolved futureId:', futureId);

        try {
           const reqUrl = `/api/detail/match?future_soulmate_id=${encodeURIComponent(futureId)}`;
           console.log('[MyProfile] fetching:', reqUrl);
           const res = await fetch(reqUrl, {
            method: 'GET'
          });
           console.log('[MyProfile] fetch status:', res.status);

          const json = await res.json();
           console.log('[MyProfile] response json:', json);
           console.log('[MyProfile] congregation field:', json.data?.congregation);
           console.log('[MyProfile] advent_status field:', json.data?.advent_status);
          if (json.status === 'success') {
            const data = json.data;

            // Set Profile Information
            document.getElementById('profile-photo').src = data.profile_photo ? `{{G_IMAGE_URL_DISPATCH}}${data.profile_photo}` : 'default-profile.jpg';
            document.getElementById('name').textContent = data.name;
            // Compute age from DOB if available
            (function(){
              try {
                const ageEl = document.getElementById('age');
                const dobStr = data.dob;
                if (ageEl && dobStr) {
                  const dob = new Date(dobStr);
                  if (!isNaN(dob)) {
                    const diffMs = Date.now() - dob.getTime();
                    const ageDate = new Date(diffMs);
                    const ageYears = Math.abs(ageDate.getUTCFullYear() - 1970);
                    ageEl.textContent = ageYears;
                  } else {
                    ageEl.textContent = '';
                  }
                }
              } catch (_) {}
            })();
            document.getElementById('job').textContent = data.job;
            document.getElementById('city').textContent = data.city;
            document.getElementById('username').textContent = data.username;
            document.getElementById('email').textContent = data.email;
            document.getElementById('congregation').textContent = data.congregation;
            document.getElementById('advent-status').textContent = data.advent_status;
            document.getElementById('hobbies').textContent = data.hobbies;
            document.getElementById('tribe').textContent = data.tribe;
            document.getElementById('marital-status').textContent = data.marital_status;
            document.getElementById('about').textContent = data.about;
            

            // Set Album Photos
            const albumContainer = document.getElementById('album-photos');
            albumContainer.innerHTML = ''; // Clear previous content
            if (data.image && data.image.length > 0) {
              data.image.forEach(photo => {
                const img = document.createElement('img');
                img.src = `{{G_IMAGE_URL_DISPATCH}}${photo}`;
                img.alt = 'Album Photo';
                img.classList.add('col-4', 'mb-2', 'img-fluid', 'rounded');
                img.style.cursor = 'pointer';
                
                img.onclick = function () {
                  openFullImageModal(img.src);
                };
                
                albumContainer.appendChild(img);
              });
            }

            // Open the modal using Bootstrap's modal methods
             $('#profileModal').modal('show');
             
             // Ensure proper scroll behavior
             $('#profileModal').on('shown.bs.modal', function () {
               $(this).css('overflow-y', 'auto');
             });
          } else {
            alert('Failed to fetch profile detail.');
          }
        } catch (err) {
          console.error(err);
          alert('Something went wrong.');
        }
      }

      // Open full-screen image modal
      function openFullImageModal(imageUrl) {
        const fullImageElement = document.getElementById('full-image');
        if (fullImageElement) {
          fullImageElement.src = imageUrl;
        }
        $('#fullImageModal').modal('show');
      }

      // Fix scroll issue when closing full image modal
      $('#fullImageModal').on('hidden.bs.modal', function () {
        // Restore scroll to the profile modal
        $('body').removeClass('modal-open');
        $('.modal-backdrop').remove();
        // Re-enable scrolling on the profile modal
        $('#profileModal').css('overflow-y', 'auto');
      });

      // Fix scroll issue when closing confirmation modal
      $('#confirmFilterModal').on('hidden.bs.modal', function () {
        // Restore scroll to the filter modal
        $('body').removeClass('modal-open');
        $('.modal-backdrop').remove();
        // Re-enable scrolling on the filter modal
        $('#filterModal').css('overflow-y', 'auto');
      });

      // Ensure proper scroll behavior when filter modal opens
      $('#filterModal').on('shown.bs.modal', function () {
        $(this).css('overflow-y', 'auto');
      });

      function openModal() {
        const modal = document.getElementById('modal'); // Assuming you have a modal element with id "modal"
        if (modal) {
          modal.style.display = 'block'; // Show the modal
        } else {
          console.error("Modal element not found.");
        }
      }

      function closeModal() {
        const modal = document.getElementById('modal');
        if (modal) {
          modal.style.display = 'none'; // Hide the modal
        } else {
          console.error("Modal element not found.");
        }
      }

      // FILTER SECTION
      
      function updateDistanceValue() {
        document.getElementById("distanceValue").textContent = document.getElementById("distanceRange").value + " km";
      }
      // USIA
      function updateAgeRangeValue() {
          const minSlider = document.getElementById("minAgeRange");
          const maxSlider = document.getElementById("maxAgeRange");

          let min = parseInt(minSlider.value);
          let max = parseInt(maxSlider.value);

          // Jika min >= max, otomatis geser max ke min + 1 (jika masih dalam batas)
          if (min >= max) {
            max = Math.min(min + 1, parseInt(maxSlider.max));
            maxSlider.value = max;
          }

          // Jika max <= min, otomatis geser min ke max - 1 (jika masih dalam batas)
          if (max <= min) {
            min = Math.max(max - 1, parseInt(minSlider.min));
            minSlider.value = min;
          }

          document.getElementById("ageRangeValue").innerText = `${min} - ${max}`;
        }

      // END USIA

      // CITY
      function handleCityChange(select) {
        const freeCities = ['Jakarta', 'Semarang', 'Bandung', 'Surabaya'];
        const selectedCity = select.value;

        if (!freeCities.includes(selectedCity)) {
          // Reset kembali ke default option
          select.value = '';
          // Tampilkan modal
          $('#premiumModal').modal('show');
        }
      }
      // END CITY
      
      function toggleDistance(checked) {
        const distanceFilter = document.getElementById("distanceFilter");
        const distanceRange = document.getElementById("distanceRange");
        const distanceValue = document.getElementById("distanceValue");
        const locWrap = document.getElementById('searcher-location');
        const card = document.getElementById('card-distance');
        const geoCtl = document.getElementById('geo-control');

        distanceFilter.style.display = checked ? 'block' : 'none';
        if (card) card.classList.toggle('disabled-section', !checked);
        if (distanceRange) distanceRange.disabled = !checked;

        if (checked) {
          distanceRange.value = 50;
          distanceValue.innerText = "50";
          // Prefill from server-side if available
          try {
            const srvLoc = JSON.parse(`{{ user_rec.location | default({}) | tojson | safe }}`);
            const coordsArr = Array.isArray(srvLoc.coordinates) ? srvLoc.coordinates : [];
            const lng = Number(coordsArr[0]);
            const lat = Number(coordsArr[1]);
            const city = srvLoc.current_city || '';
            const prov = srvLoc.current_province || '';
            const country = srvLoc.current_country || '';
            const date = srvLoc.lastGeoDate || '';
            const cityEl = document.getElementById('loc-city');
            const provEl = document.getElementById('loc-prov');
            const countryEl = document.getElementById('loc-country');
            if (cityEl && provEl && countryEl) {
              cityEl.textContent = city;
              provEl.textContent = prov ? (city ? `, ${prov}` : prov) : '';
              countryEl.textContent = country ? ((city || prov) ? `, ${country}` : country) : '';
            }
            if ((city || prov || country) && locWrap) locWrap.style.display = 'inline';
            if (geoCtl) {
              if (date) {
                geoCtl.innerHTML = `<span class="text-muted">Lokasi tersimpan pada ${date}. </span><button class="btn btn-sm btn-outline-primary ml-2" type="button" onclick="refreshLocationNow()">Update lokasi</button>`;
              } else {
                geoCtl.innerHTML = `<span class="text-warning">Lokasi Anda belum terdata. </span><button class="btn btn-sm btn-primary ml-2" type="button" onclick="refreshLocationNow()">Set lokasi sekarang</button>`;
              }
            }
          } catch (_) {}
        } else {
          distanceRange.value = 0;
          distanceValue.innerText = "0";
          if (locWrap) locWrap.style.display = 'none';
          if (geoCtl) geoCtl.innerHTML = '';
        }
      }



      function toggleAge(show) {
        document.getElementById("ageFilter").style.display = show ? 'block' : 'none';
        const card = document.getElementById('card-age');
        if (card) card.classList.toggle('disabled-section', !show);
      }

      function toggleHometown(show) {
        document.getElementById("hometownFilter").style.display = show ? 'block' : 'none';
        const card = document.getElementById('card-hometown');
        if (card) card.classList.toggle('disabled-section', !show);
      }

      function toggleCurrentCity(show) {
        document.getElementById("currentCityFilter").style.display = show ? 'block' : 'none';
      }

      function toggleMaritalStatus(show) {
        document.getElementById("maritalStatusFilter").style.display = show ? 'block' : 'none';
        const card = document.getElementById('card-marital');
        if (card) card.classList.toggle('disabled-section', !show);
      }  

      // Helper: update location line under Radius card
      function updateSearcherLocationDisplay(city, prov, country, longitude, latitude, lastGeoDate) {
        try {
          const wrap = document.getElementById('searcher-location');
          if (!wrap) return;
          const cityEl = document.getElementById('loc-city');
          const provEl = document.getElementById('loc-prov');
          const countryEl = document.getElementById('loc-country');

          const cCity = city || '';
          const cProv = prov || '';
          const cCountry = country || '';

          if (cityEl && provEl && countryEl) {
            cityEl.textContent = cCity ? cCity : '';
            provEl.textContent = cProv ? (cCity ? `, ${cProv}` : cProv) : '';
            countryEl.textContent = cCountry ? ((cCity || cProv) ? `, ${cCountry}` : cCountry) : '';
          }
          // Show only if any part exists
          wrap.style.display = (cCity || cProv || cCountry) ? 'inline' : 'none';
        } catch (e) {
          console.error('updateSearcherLocationDisplay error:', e);
        }
      }

      function buildFilterPayload(extra) {
        const useAge = document.getElementById('useAge')?.checked;
        const minAgeEl = document.getElementById('minAgeRange');
        const maxAgeEl = document.getElementById('maxAgeRange');
        const minAgeVal = useAge && minAgeEl ? parseInt(minAgeEl.value || '18', 10) : 18;
        const maxAgeVal = useAge && maxAgeEl ? parseInt(maxAgeEl.value || '60', 10) : 60;

        const useDistance = document.getElementById('useDistance')?.checked;
        const distanceRangeEl = document.getElementById('distanceRange');
        const distanceVal = (useDistance && distanceRangeEl) ? parseInt(distanceRangeEl.value || '0', 10) : 0;

        const useHometown = document.getElementById('useHometown')?.checked;
        const hometownEl = document.getElementById('hometown');
        const hometownVal = (useHometown && hometownEl) ? (hometownEl.value || '') : '';

        const useMarital = document.getElementById('useMaritalStatus')?.checked;
        const maritalVal = useMarital ? (document.querySelector("input[name='maritalStatus']:checked")?.id || '') : '';

        const payload = {
          min_age: isNaN(minAgeVal) ? 18 : minAgeVal,
          max_age: isNaN(maxAgeVal) ? 60 : maxAgeVal,
          distance: isNaN(distanceVal) ? 0 : distanceVal,
          hometown: hometownVal || undefined,
          maritalStatus: maritalVal || undefined
        };
        if (extra && typeof extra === 'object') {
          Object.assign(payload, extra);
        }
        return payload;
      }

      function applyFiltersNonPremium() {
        console.log('applyFiltersNonPremium()');
        const payload = buildFilterPayload();
        sendFilterRequest(payload);
      }
   
      function applyFilters() {
        console.log('applyFilters()');
        const useDistance = document.getElementById('useDistance')?.checked;
        const distanceRangeEl = document.getElementById('distanceRange');
        const distanceVal = (useDistance && distanceRangeEl) ? parseInt(distanceRangeEl.value || '0', 10) : 0;
        const distance = isNaN(distanceVal) ? 0 : distanceVal;
        const geoCtl = document.getElementById('geo-control');

        // Jika radius tidak aktif atau 0, jangan minta geolocation
        if (!useDistance || distance <= 0) {
          const payload = buildFilterPayload({ distance: 0 });
          sendFilterRequest(payload);
          return;
        }

        // Radius aktif: minta lokasi jika perlu
        const lastGeoDate = "{{ user_rec.location.lastGeoDate }}";
        const today = new Date().toISOString().split('T')[0];

        if (lastGeoDate !== today) {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              function (position) {
                const OPENCAGE_API_KEY = "a1ec8bfdf9524ee09594cbacb5537ae6";
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;

                fetch(`https://api.opencagedata.com/geocode/v1/json?q=${latitude}+${longitude}&key=${OPENCAGE_API_KEY}`)
                  .then(response => response.json())
                  .then(data => {
                    let city = "";
                    let prov = "";
                    let country = "";

                    if (data?.results?.length > 0) {
                      const components = data.results[0].components;
                      city = components.city || components.town || components.village || components.county || "";
                      prov = components.state || "";
                      country = components.country || "";
                    }

                    const currentCityEl = document.getElementById("currentCity");
                    // show under radius
                    try {
                      const locWrap = document.getElementById('searcher-location');
                      const cityEl = document.getElementById('loc-city');
                      const provEl = document.getElementById('loc-prov');
                      const countryEl = document.getElementById('loc-country');
                      if (cityEl && provEl && countryEl) {
                        cityEl.textContent = city;
                        provEl.textContent = prov ? (city ? `, ${prov}` : prov) : '';
                        countryEl.textContent = country ? ((city || prov) ? `, ${country}` : country) : '';
                      }
                      if (locWrap) locWrap.style.display = 'inline';
                    } catch(_) {}
                    const payload = buildFilterPayload({
                      distance: distance,
                      currentCity: currentCityEl ? currentCityEl.value : undefined,
                      current_position: { latitude, longitude, city, prov, country }
                    });
                    sendFilterRequest(payload);
                    if (geoCtl) geoCtl.innerHTML = `<span class=\"text-muted\">Lokasi diupdate hari ini. </span><button class=\"btn btn-sm btn-outline-primary ml-2\" type=\"button\" onclick=\"refreshLocationNow()\">Update lagi</button>`;
                  })
                  .catch(error => {
                    console.error("Gagal ambil data dari OpenCage:", error);

                    const currentCityEl2 = document.getElementById("currentCity");
                    const payload = buildFilterPayload({
                      distance: distance,
                      currentCity: currentCityEl2 ? currentCityEl2.value : undefined,
                      current_position: { latitude, longitude }
                    });
                    sendFilterRequest(payload);
                    if (geoCtl) geoCtl.innerHTML = `<span class=\"text-warning\">Gagal reverse geocoding. </span><button class=\"btn btn-sm btn-outline-primary ml-2\" type=\"button\" onclick=\"refreshLocationNow()\">Coba update lagi</button>`;
                  });
              },
              function (error) {
                console.error("Geolocation error:", error.message);
                const payload = buildFilterPayload({ distance });
                sendFilterRequest(payload);
                if (geoCtl) geoCtl.innerHTML = `<span class=\"text-danger\">Geolocation ditolak/gagal. </span><button class=\"btn btn-sm btn-outline-primary ml-2\" type=\"button\" onclick=\"refreshLocationNow()\">Coba lagi</button>`;
              }
            );
          } else {
            alert("Browser kamu tidak mendukung fitur lokasi otomatis.");
            const payload = buildFilterPayload({ distance });
            sendFilterRequest(payload);
            if (geoCtl) geoCtl.innerHTML = `<span class=\"text-danger\">Browser tidak mendukung lokasi. </span>`;
          }
        } else {
          const currentCityEl5 = document.getElementById("currentCity");
          // Last location already saved today: reflect it in the UI when radius is active
          if (useDistance && distance > 0) {
            try {
              const srvLoc = JSON.parse(`{{ user_rec.location | default({}) | tojson | safe }}`);
              if (srvLoc && (srvLoc.current_city || srvLoc.current_province || srvLoc.current_country)) {
                const coordsArr = Array.isArray(srvLoc.coordinates) ? srvLoc.coordinates : [];
                const lng = Number(coordsArr[0]);
                const lat = Number(coordsArr[1]);
                if (!isNaN(lng) && !isNaN(lat)) {
                  updateSearcherLocationDisplay(srvLoc.current_city || '', srvLoc.current_province || '', srvLoc.current_country || '', lng, lat, srvLoc.lastGeoDate || '');
                } else {
                  updateSearcherLocationDisplay(srvLoc.current_city || '', srvLoc.current_province || '', srvLoc.current_country || '', null, null, srvLoc.lastGeoDate || '');
                }
                if (geoCtl) geoCtl.innerHTML = `<span class=\"text-muted\">Lokasi tersimpan pada ${srvLoc.lastGeoDate || ''}. </span><button class=\"btn btn-sm btn-outline-primary ml-2\" type=\"button\" onclick=\"refreshLocationNow()\">Update lokasi</button>`;
              }
            } catch (_) {}
          }
          const payload = buildFilterPayload({
            distance: distance,
            currentCity: currentCityEl5 ? currentCityEl5.value : undefined
          });
          sendFilterRequest(payload);
        }
      }

      // Manual refresh (to avoid hitting reverse geocoding tiap toggle ON)
      function refreshLocationNow() {
        const geoCtl = document.getElementById('geo-control');
        if (!navigator.geolocation) {
          if (geoCtl) geoCtl.innerHTML = `<span class=\"text-danger\">Browser tidak mendukung lokasi.</span>`;
          return;
        }
        navigator.geolocation.getCurrentPosition(async function (position) {
          try {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            const OPENCAGE_API_KEY = "a1ec8bfdf9524ee09594cbacb5537ae6";
            const resp = await fetch(`https://api.opencagedata.com/geocode/v1/json?q=${latitude}+${longitude}&key=${OPENCAGE_API_KEY}`);
            const json = await resp.json();
            let city = "", prov = "", country = "";
            if (json?.results?.length > 0) {
              const components = json.results[0].components;
              city = components.city || components.town || components.village || components.county || "";
              prov = components.state || "";
              country = components.country || "";
            }
            updateSearcherLocationDisplay(city, prov, country, longitude, latitude, new Date().toISOString().slice(0,10));
            if (geoCtl) geoCtl.innerHTML = `<span class=\"text-muted\">Lokasi diupdate hari ini.</span>`;
          } catch (e) {
            if (geoCtl) geoCtl.innerHTML = `<span class=\"text-danger\">Gagal update lokasi.</span>`;
          }
        }, function (error) {
          if (geoCtl) geoCtl.innerHTML = `<span class=\"text-danger\">Geolocation gagal: ${error.message}</span>`;
        });
      }

      function sendFilterRequest(filterData) {
        console.log("Filter yang dikirim:", filterData); // Debug

        // Gabungkan CSRF token ke dalam filterData
        filterData.csrf_token = "{{ csrf_token() }}";

        $('#loading-card').show(); // Show loader

        $.post(apiUrl, filterData)
          .done(function (resp) {
            frame.innerHTML = '';

            // Reset swipe state
            swipedCount = 0;
            skipCount = 0;
            current = null;
            likeText = null;

            const data = resp.map(item => ({
              img: item.img,
              name: item.name,
              age: item.age,
              city: item.city,
              distance: item.distance,
              future_wife_id: item.user_id
            }));
                    
            if (resp.length === 0 ) {
              // Jika data kosong, tampilkan card placeholder dengan state TERBARU dari UI
              appendcard_swipe_empty(filterData);
            } else {
              // Kalau ada data, append semua card
              data.forEach(item => appendcard_swipe(item));
            }                       

            // ✅ Reattach swipe listener
            current = frame.querySelector('.card_swipe:last-child');
            if (current) {
              likeText = current.children[0];
              initcard_swipe(current);
            }       

            setTimeout(() => {
              $('#loading-card').hide();
            }, 100);
          })
          .fail(function (err) {
            console.error("Gagal fetch data filter:", err);
            $('#loading-card').hide();
          });
      }

      function resetFilters() {
        // Full page reload
        location.reload();
      }
      // END FILTER SECTION

      // START PREMIUM MODAL BEHAVIOR
      
      
      
      function handleDistanceChange() {
        const isPremium = document.body.getAttribute('data-is-premium');
        const rangeInput = document.getElementById('distanceRange');
        const distanceValue = document.getElementById('distanceValue');
        if (rangeInput && rangeInput.disabled) return; // ignore when disabled
        if (isPremium == "FALSE") {
          // Reset to 0
          rangeInput.value = 0;
          distanceValue.textContent = 0;
          $('#premiumModal').modal('show');
        } else {
          distanceValue.textContent = rangeInput.value;
        }
      }
      // END PREMIUM MODAL BEHAVIOR

      // Build confirmation summary and show modal
      function openConfirmFilters() {
        const chips = [];
        const useAge = document.getElementById('useAge')?.checked;
        const minAge = document.getElementById('minAgeRange')?.value;
        const maxAge = document.getElementById('maxAgeRange')?.value;
        if (useAge && minAge && maxAge) chips.push(`Usia ${minAge}-${maxAge}`);

        const useHometown = document.getElementById('useHometown')?.checked;
        const hometown = document.getElementById('hometown')?.value;
        if (useHometown && hometown) chips.push(`Asal ${hometown}`);

        const useDistance = document.getElementById('useDistance')?.checked;
        const distance = document.getElementById('distanceRange')?.value;
        if (useDistance && distance && distance !== '0') chips.push(`Radius ${distance} km`);

        const useMarital = document.getElementById('useMaritalStatus')?.checked;
        const marital = document.querySelector("input[name='maritalStatus']:checked")?.id;
        if (useMarital && marital) chips.push(`Status ${marital}`);

        const summaryEl = document.getElementById('confirm-filter-summary');
        if (summaryEl) {
          summaryEl.innerHTML = chips.length ? chips.map(c => `<span class="filter-chip">${c}</span>`).join('') : '<em>Tidak ada filter diterapkan</em>';
        }
        try {
          if (typeof $ !== 'undefined' && $('#confirmFilterModal').modal) {
            console.log('Opening confirm modal');
            $('#confirmFilterModal').modal('show');
          } else {
            const proceed = window.confirm((chips.length ? chips.join(', ') : 'Tidak ada filter diterapkan') + '\n\nMulai pencarian?');
            if (proceed) {
              const isPremium = document.body.getAttribute('data-is-premium');
              if (isPremium === 'TRUE') {
                applyFilters();
              } else {
                applyFiltersNonPremium();
              }
            }
          }
        } catch (e) {
          console.error('Failed to open confirm modal:', e);
        }
      }

      // Bind Apply Filters and My Profile buttons; run now or on DOMContentLoaded
      (function initBindings() {
        const bind = function() {
          const isPremium = document.body.getAttribute('data-is-premium');
          const applyBtn = document.getElementById('apply-filters-btn');
          if (applyBtn && !applyBtn._bound) {
            applyBtn.addEventListener('click', function() {
              console.log('apply-filters-btn clicked');
              openConfirmFilters();
            });
            applyBtn._bound = true;
          }

          // Ensure radius default is disabled on load
          try {
            const useDistance = document.getElementById('useDistance');
            const distanceRange = document.getElementById('distanceRange');
            const distanceValue = document.getElementById('distanceValue');
            const distanceFilter = document.getElementById('distanceFilter');
            const card = document.getElementById('card-distance');
            if (useDistance) {
              useDistance.checked = false;
            }
            if (distanceRange) {
              distanceRange.value = 0;
              distanceRange.disabled = true;
            }
            if (distanceValue) distanceValue.innerText = '0';
            if (distanceFilter) distanceFilter.style.display = 'none';
            if (card) card.classList.add('disabled-section');
          } catch(_) {}

          const confirmBtn = document.getElementById('confirm-apply-btn');
          if (confirmBtn && !confirmBtn._bound) {
            confirmBtn.addEventListener('click', function() {
              console.log('confirm-apply-btn clicked');
              try { $('#confirmFilterModal').modal('hide'); } catch (_) {}
              try { $('#filterModal').modal('hide'); } catch (_) {}
              if (isPremium === 'TRUE') {
                applyFilters();
              } else {
                applyFiltersNonPremium();
              }
            });
            confirmBtn._bound = true;
          }

          const myUserId = document.body.getAttribute('data-user-id');
          const hookMyProfile = function(btn) {
            if (!btn || btn._bound) return;
            btn.addEventListener('click', function() {
              if (!myUserId) return;
              // call detail flow with explicit id
              console.log('myUserId', myUserId);
              showFutureWifeId(myUserId);
            });
            btn._bound = true;
          };
          hookMyProfile(document.getElementById('btn-show-my-profile'));
          hookMyProfile(document.getElementById('btn-floating-my-profile'));
        };

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', bind);
        } else {
          bind();
        }
      })();

      function onConfirmApplyFilters() {
        console.log('onConfirmApplyFilters()');
        try { $('#confirmFilterModal').modal('hide'); } catch(_) {}
        try { $('#filterModal').modal('hide'); } catch(_) {}
        const isPremium = document.body.getAttribute('data-is-premium');
        if (isPremium === 'TRUE') {
          applyFilters();
        } else {
          applyFiltersNonPremium();
        }
      }

      // Fallback delegation in case direct binding fails
      document.addEventListener('click', function(e) {
        const target = e.target;
        if (!target) return;
        if (target.id === 'apply-filters-btn' || (target.closest && target.closest('#apply-filters-btn'))) {
          console.log('apply-filters-btn delegated click');
          e.preventDefault();
          openConfirmFilters();
        } else if (target.id === 'confirm-apply-btn' || (target.closest && target.closest('#confirm-apply-btn'))) {
          console.log('confirm-apply-btn delegated click');
          e.preventDefault();
          try { $('#confirmFilterModal').modal('hide'); } catch (_) {}
          try { $('#filterModal').modal('hide'); } catch (_) {}
          const isPremium = document.body.getAttribute('data-is-premium');
          if (isPremium === 'TRUE') {
            applyFilters();
          } else {
            applyFiltersNonPremium();
          }
        }
      });

      // Chips updater for quick visual summary
      (function initFilterChips(){
        const chipsEl = document.getElementById('filter-chips');
        if (!chipsEl) return;
        function renderChips(){
          const chips = [];
          const useAge = document.getElementById('useAge')?.checked;
          const minAge = document.getElementById('minAgeRange')?.value;
          const maxAge = document.getElementById('maxAgeRange')?.value;
          if (useAge && minAge && maxAge) chips.push(`Usia ${minAge}-${maxAge}`);

          const useHometown = document.getElementById('useHometown')?.checked;
          const hometown = document.getElementById('hometown')?.value;
          if (useHometown && hometown) chips.push(`Asal ${hometown}`);

          const useDistance = document.getElementById('useDistance')?.checked;
          const distance = document.getElementById('distanceRange')?.value;
          if (useDistance && distance && distance !== '0') chips.push(`Radius ${distance} km`);

          const useMarital = document.getElementById('useMaritalStatus')?.checked;
          const marital = document.querySelector("input[name='maritalStatus']:checked")?.id;
          if (useMarital && marital) chips.push(`Status ${marital}`);

          chipsEl.innerHTML = chips.map(c => `<span class="filter-chip">${c}</span>`).join('');
        }
        const ids = ['useAge','minAgeRange','maxAgeRange','useHometown','hometown','useDistance','distanceRange','useMaritalStatus'];
        ids.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          const evt = (el.tagName === 'SELECT' || el.type === 'checkbox' || el.type === 'radio') ? 'change' : 'input';
          el.addEventListener(evt, renderChips);
        });
        document.querySelectorAll("input[name='maritalStatus']").forEach(el => el.addEventListener('change', renderChips));
        renderChips();

        // Update chips when toggles change (for disabled look and live summary)
        const toggleIds = ['useAge','useHometown','useDistance','useMaritalStatus'];
        toggleIds.forEach(id => {
          const t = document.getElementById(id);
          if (!t) return;
          t.addEventListener('change', renderChips);
        });
      })();
   </script>

</body>
{% endautoescape %}

</html>